<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>jQuery モダンAjaxな書き方を目指して　〜Deferredを使ったAJAX〜 - Hack Your Design!</title>
  <meta name="viewport" content="width=device-width">
  <script src="/js/modernizr-2.6.2.min.js"></script>
  <link rel="stylesheet" href="/css/main.css">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@toshimaru_e">
  <meta name="twitter:title" content="jQuery モダンAjaxな書き方を目指して　〜Deferredを使ったAJAX〜 - Hack Your Design!">
  <meta property="og:title" content="jQuery モダンAjaxな書き方を目指して　〜Deferredを使ったAJAX〜 - Hack Your Design!">
  <meta name="twitter:description" content="jQeuryにおけるモダンAjaxな書き方を目指して、ステップ・バイ・ステップでコード付き解説していきます。"><meta property="og:description" content="jQeuryにおけるモダンAjaxな書き方を目指して、ステップ・バイ・ステップでコード付き解説していきます。">
  <meta property="og:image" content="http://blog.toshimaru.net/images/icon.png" /><meta name="twitter:image" content="http://blog.toshimaru.net/images/icon.png" />
  <meta property="og:type" content="article">
  <!-- Place apple-touch-icon.png in the root directory -->
</head>
<body>
  <!--[if lt IE 7]> <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p> <![endif]-->
  <header class="clearfix">
<div id="header-top">
  <h1 id="logo"><a href="/">Hack Your Design!</a></h1>
</div>
<div id="toggle-menu" class="clearfix"><i class="icon-reorder"></i></div>
<nav id="navigation">
  <div id="toggle-item">
  <a href="/">Blog</a>
  <a href="/archive.html">Archive</a>
  <a href="/about.html">About</a>
  </div>
</nav>
</header>
  <div class="main-wrapper">
    <div class="main clearfix">
      <div id="contents">
       <div class="posts">
  <h1>jQuery モダンAjaxな書き方を目指して　〜Deferredを使ったAJAX〜</h1>
  <div class="meta">
    <div class="clearfix">
      <i class="icon-calendar"></i><time datetime="2012-12-13T00:00:00+00:00" pubdate>13 Dec 2012</time>
      <i class="icon-tags"></i><a href="/tag/jquery.html" rel="tag">jquery</a>
    </div>
    
  </div>
</div>

<p>本エントリは<a href="http://www.adventar.org/calendars/29">軽めのjQuery Advent Calendar 2012</a>の14日目の記事として書きます。</p>
<p>軽めといいながら少し重めになってしまった感がありますが、初めてのAdvent Calendar参加ということでご勘弁を。。。</p>
<p>※ Twitter API仕様変更によりTwitter APIを使ったコードは動かなくなっていることにご注意。</p>
<h2>jQuery 1.4以前の書き方</h2>
<p>まずは、少し古めのコード、昔のjQueryの本とかでよく見る書き方。</p>
<div class="CodeRay">
  <div class="code"><pre>$.ajax({
    url: &quot;ajax.html&quot;,
    success: function(data) {
       alert('success!!');
    },
    error: function(data) {
       alert('error!!!');
    }
});</pre></div>
</div>

<h2>jQuery 1.5以上の書き方</h2>
<p>1.5以降だと、<code>$.ajax()</code> は<a href="http://api.jquery.com/jQuery.ajax/#jqXHR">jqXHRオブジェクト</a>を返すようになります。それを利用した書き方はこう。</p>
<div class="CodeRay">
  <div class="code"><pre>$.ajax({
    url: &quot;ajax.html&quot;,
}).success(function(data){
    alert('success!!');
}).error(function(data){
    alert('error!!!');
});</pre></div>
</div>

<p>成功時の処理と失敗時の処理が<code>ajax()</code>と並列に書くことができ、コード全体の見通しがぐっとよくなりましたね。</p>
<h2>jQuery 1.8以上の書き方</h2>
<p><a href="http://api.jquery.com/jQuery.ajax/">公式リファレンス</a>いわく、</p>
<blockquote class="posterous_medium_quote">Deprecation Notice: The jqXHR.success(), jqXHR.error(), and jqXHR.complete() callbacks will be deprecated in jQuery 1.8. To prepare your code for their eventual removal, use jqXHR.done(), jqXHR.fail(), and jqXHR.always() instead.</blockquote>
<p>つまりjQuery1.8から</p>
<ul>
<li><code>success()</code> は <code>done()</code> に、</li>
<li><code>error()</code> は <code>fail()</code> に、</li>
<li><code>complete()</code> は <code>always()</code>を</li>
</ul>
<p>代わりに使ってね、ってことです。ということで、<code>success()</code>,<code>error()</code>は使わない。</p>
<div class="CodeRay">
  <div class="code"><pre>$.ajax({
    url: &quot;ajax.html&quot;,
}).done(function(data){
    alert('success!!');
}).fail(function(data){
    alert('error!!!');
});</pre></div>
</div>

<p>あるいは<code>then()</code>を用いてこう書いてもいいでしょう。</p>
<div class="CodeRay">
  <div class="code"><pre>$.ajax({
    url: &quot;ajax.html&quot;,
}).then(
function(data){ alert('success!!'); },
function(data){ alert('error!!');   }
);</pre></div>
</div>

<p><code>then()</code>の一個目の関数が成功時、二個目の関数が失敗時となります。</p>
<h2>（発展編）Deferredを用いた書き方</h2>
<p>上述した例の中でさりげなくDeferredな書き方を使っていましたが、発展編ということでこのDeferredな書き方をさらに突き詰めてみましょう。</p>
<h3>deferredとは何か？</h3>
<blockquote>
<p>jQuery.Deferred() introduces several enhancements to the way callbacks are managed and invoked. In particular, jQuery.Deferred() provides flexible ways to provide multiple callbacks, and these callbacks can be invoked regardless of whether the original callback dispatch has already occurred. jQuery Deferred is based on the CommonJS Promises/A design.</p>
<p>jQuery.Deferred() はコールバック関数の管理、実行に改善をもたらします。具体的には、jQuery.Deferred()は複数のコールバックの実行を柔軟に行うことができ、これらのコールバック関数は、オリジナルのコールバックのディスパッチが発生しているかどうかにかかわらず実行されます。</p>
</blockquote>
<p>要はコールバック関数の実行を延期(deferred)させて、<code>.then()</code> <code>.fail()</code> <code>.always()</code>なんかを使って柔軟にコールバックを管理、実行できるってことです（雑）。</p>
<p>詳しくは下記を読むとよいでしょう。</p>
<ul>
<li><a href="http://msdn.microsoft.com/en-us/magazine/gg723713.aspx">Creating Responsive Applications Using jQuery Deferred and Promises</a></li>
<li>@tokkonoPapaさんによる上記事の翻訳はこちら:<a href="http://tokkono.cute.coocan.jp/blog/slow/index.php/programming/jquery-deferred-for-responsive-applications-basic/">jQueryのDeferredとPromiseで応答性の良いアプリをー基本編</a></li>
</ul>
<p>論より実践。deferredをうまく使ったAJAXコードを見てみましょう。</p>
<p><a href="http://jsfiddle.net/toshimaru/yP58L/1/light/">jsfiddleでの実例</a></p>
<div class="CodeRay">
  <div class="code"><pre>var Twitter = {
    search: function(query) {
        var defer = $.Deferred();
        $.ajax({
            url: &quot;http://search.twitter.com/search.json&quot;,
            data: {
                q: query,
                rpp: 50
            },
            dataType: 'jsonp',
            success: defer.resolve,
            error: defer.reject
        });
        return defer.promise();
    }
};

$('#button').on('click', function() {
    Twitter.search('jquery deferred').done(function(data) {
        console.log(data);
        $(data.results).each(function(k,v){ 
           $('#tweets').append(v.text + '&lt;br/&gt;'); 
        });
    });
});</pre></div>
</div>

<p>見てわかるとおり、deferredを使うことでtwitterの検索を行うAJAX部分と結果取得時のイベント処理部分が分離できます。</p>
<p>これによりネストが深くならずに済み、コードの可読性が上がります。また、イベント処理部分のほうは <code>Twitter.search('query hoge').done(function(){//code...})</code> と書くだけですから、ajax部分を気にすることなく結果取得後のイベント処理に意識を集中して書くことができます。素晴らしいですネ。</p>
<h2>（発展編２）$.when() を用いた書き方</h2>
<p><code>$.when()</code>を用いると複数のdeferredオブジェクトをまとめて管理できます。</p>
<p><a href="http://jsfiddle.net/toshimaru/nNMae/">jsfiddleでの実例</a></p>
<div class="CodeRay">
  <div class="code"><pre>// &quot;Twitter&quot; のコードは同上

$('#button').on('click', function() {
    $.when(Twitter.search('jquery deferred'), Twitter.search('jquery when')) 
    .then(function(data1, data2){
        console.log(data1);
        console.log(data2);
    });
});</pre></div>
</div>

<p>when内のdiferredオブジェクト全ての処理が完了すると、その後の処理が発火します。複数のAJAX結果をまとめて処理したいってときに使えます。</p>
<hr />
<p>いかがだったでしょうか？ diferredオブジェクトを使うことでより楽しいAjaxライフが送れそうですね。ワクワクしますね。</p>
<p>本日のコードは<a href="https://gist.github.com/4269484">gist</a>にも上げております。</p>
<p>では次の方にバトンタッチ〜</p>
<h3>参考</h3>
<ul>
<li><a href="http://d.hatena.ne.jp/aoe-tk/20110515/1305471586">jQueryのDeferredオブジェクトについて調べてみた</a></li>
<li><a href="http://tokkono.cute.coocan.jp/blog/slow/index.php/programming/how-happy-with-jquery-deferred-for-your-applications/">jQueryのDeferredとPromiseで応答性の良いアプリをー実践編</a></li>
</ul>


<ul id="social-buttons">
  <li class="twitter"><a href="https://twitter.com/share" class="twitter-share-button" data-via="toshimaru_e">Tweet</a></li>
  <li class="facebook"><div class="fb-like" data-send="false" data-layout="button_count" data-width="100" data-show-faces="false"></div></li>
  <li class="hatena"><a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/jquery-ajaxdeferredajax/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard-balloon" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a></li>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  <script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>
</ul>


  <div class="related">
  <h3>関連エントリ</h3>
  <ul>
  
    <li><a href="/jquery-bottom-scroll/" title="jQueryでページ最下部のスクロール時のイベントをキャッチする">jQueryでページ最下部のスクロール時のイベントをキャッチする</a></li>
  
    <li><a href="/jquerydeferred-is-most-important-client/" title="DeferredはjQueryにおける最も重要なクライアントサイドツール">DeferredはjQueryにおける最も重要なクライアントサイドツール</a></li>
  
    <li><a href="/jqueryhidden-inputjquery/" title="hidden inputタグをjQueryで追加">hidden inputタグをjQueryで追加</a></li>
  
    <li><a href="/jqueryfadein/" title="jQueryで画像を順番にfadeInする">jQueryで画像を順番にfadeInする</a></li>
  
    <li><a href="/twitter-search-api-js/" title="twitter search API をJSで呼んでみる">twitter search API をJSで呼んでみる</a></li>
  
  </ul>
  </div>


<div class="post-pagination clearfix">
  
  <div class="newer">
    <a href="/vimsublime-text-2/" title="Newer Post: Vimから３日で乗り換えた、次世代モテエディタ「Sublime Text 2」の魅力"><i class="icon-chevron-left"></i>  Newer</a>
  </div>
  

  
  <div class="older">
    <a href="/iphone4/" title="Older Post: iPhone4を着せ替えしてみた。">Older  <i class="icon-chevron-right"></i></a>
  </div>
  
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hackyourdesign'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
    </div>
  </div>
  <footer>
	<div class="main">
		<div class="wrapper clearfix">
			<div class="about">
				
				<h2>About</h2>
				<img id="profile_pic" src="/images/profile.jpg" alt="profile picture" height="110" width="110">
				<dl class="about-dl">
					<dt>Toshimaru</dt>
					<dd>Web Developer. 現在カナダのバンクーバにて修行中。技術ネタをよく書いてます。最近興味あるのはRoRとフロントエンド関連技術。</dd>
				</dl>
				<ul class="externallinks">
					<li><a href="https://twitter.com/toshimaru_e" class="icon-twitter-sign"></a></li>
					<li><a href="https://github.com/toshimaru" class="icon-github-sign"></a></li>
				</ul>
				
			</div>
			<div class="center">
				<h2>Popular</h2>
				<ul>
					<li><a href="/jquery-ajaxdeferredajax/">jQuery モダンAjaxな書き方を目指して　〜deferredを使ったAJAX〜</a> <a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/jquery-ajaxdeferredajax/"><img src="http://b.hatena.ne.jp/entry/image/http://blog.toshimaru.net/jquery-ajaxdeferredajax/"></a>
</li>
					<li><a href="/Front-end-Developer-Interview-Questions-Japanese/">「フロントエンドデベロッパー面接時の質問事項」日本語訳しました</a> <a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/Front-end-Developer-Interview-Questions-Japanese/"><img src="http://b.hatena.ne.jp/entry/image/http://blog.toshimaru.net/Front-end-Developer-Interview-Questions-Japanese/"></a>
</li>
					<li><a href="/jquerydeferred-is-most-important-client/">DeferredはjQueryにおける最も重要なクライアントサイドツール</a> <a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/jquerydeferred-is-most-important-client/"><img src="http://b.hatena.ne.jp/entry/image/http://blog.toshimaru.net/jquerydeferred-is-most-important-client/"></a>
</li>
					<li><a href="/git-log-graph/">美しき git log --graph のエイリアス</a> <a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/git-log-graph/"><img src="http://b.hatena.ne.jp/entry/image/http://blog.toshimaru.net/git-log-graph/"></a>
</li>
					<li><a href="/vimsublime-text-2/">Vimから３日で乗り換えた、次世代モテエディタ「Sublime Text 2」の魅力</a> <a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/vimsublime-text-2/"><img src="http://b.hatena.ne.jp/entry/image/http://blog.toshimaru.net/vimsublime-text-2/"></a>
</li>
					<li><a href="/how-to-find-job-in-Vancouver/">僕が単身海外（バンクーバー）に来て仕事を見つけるまでにやったこと</a> <a href="http://b.hatena.ne.jp/entry/blog.toshimaru.net/how-to-find-job-in-Vancouver/"><img src="http://b.hatena.ne.jp/entry/image/http://blog.toshimaru.net/how-to-find-job-in-Vancouver/"></a>
</li>
				</ul>
			</div>
			<div class="right">
				<h2>Tag</h2>
				<div class="tags"><a href="/tag/android.html" class="set-1">android</a> <a href="/tag/aws.html" class="set-1">aws</a> <a href="/tag/chrome.html" class="set-1">chrome</a> <a href="/tag/css.html" class="set-2">css</a> <a href="/tag/design.html" class="set-2">design</a> <a href="/tag/facebook.html" class="set-1">facebook</a> <a href="/tag/git.html" class="set-4">git</a> <a href="/tag/github.html" class="set-1">github</a> <a href="/tag/html.html" class="set-1">html</a> <a href="/tag/iphone.html" class="set-1">iphone</a> <a href="/tag/java.html" class="set-1">java</a> <a href="/tag/javascript.html" class="set-4">javascript</a> <a href="/tag/jekyll.html" class="set-2">jekyll</a> <a href="/tag/jquery.html" class="set-3">jquery</a> <a href="/tag/linux.html" class="set-3">linux</a> <a href="/tag/mac.html" class="set-2">mac</a> <a href="/tag/mail.html" class="set-1">mail</a> <a href="/tag/markdown.html" class="set-1">markdown</a> <a href="/tag/mysql.html" class="set-1">mysql</a> <a href="/tag/network.html" class="set-1">network</a> <a href="/tag/npm.html" class="set-1">npm</a> <a href="/tag/perl.html" class="set-1">perl</a> <a href="/tag/php.html" class="set-5">php</a> <a href="/tag/python.html" class="set-1">python</a> <a href="/tag/rails.html" class="set-1">rails</a> <a href="/tag/ruby.html" class="set-2">ruby</a> <a href="/tag/scala.html" class="set-1">scala</a> <a href="/tag/security.html" class="set-1">security</a> <a href="/tag/shell.html" class="set-1">shell</a> <a href="/tag/sinatra.html" class="set-1">sinatra</a> <a href="/tag/sublimetext.html" class="set-1">sublimetext</a> <a href="/tag/svn.html" class="set-1">svn</a> <a href="/tag/tech.html" class="set-3">tech</a> <a href="/tag/vancouver.html" class="set-2">vancouver</a> <a href="/tag/vim.html" class="set-1">vim</a> <a href="/tag/windows.html" class="set-1">windows</a> <a href="/tag/zsh.html" class="set-1">zsh</a> <a href="/tag/%E6%B5%B7%E5%A4%96%E5%B0%B1%E5%8A%B4.html" class="set-1">海外就労</a> <a href="/tag/%E9%9B%91%E8%A8%98.html" class="set-1">雑記</a></div>
			</div>
		</div>
		<p class="credit">Designed and coded by <a href="/about.html">Toshi</a></p>
	</div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="/js/main.js"></script>
  <script>
      var _gaq=[['_setAccount','UA-35177276-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
</body>
</html>
